<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë¬´ì œí‘œ ì‹œê°í™”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        body {
            background-color: #003050;
            color: #e0e0e0;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #004080 0%, #002040 100%);
            color: white;
            padding: 60px 0;
        }
        
        .search-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .company-result {
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #004060;
            color: #e0e0e0;
            border: 1px solid #005080;
        }
        
        .company-result:hover {
            background-color: #005080;
            transform: translateY(-2px);
            color: white;
        }
        
        .loading {
            display: none;
        }
        
        .chart-container {
            background: #004060;
            border-radius: 10px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #005080;
        }
        
        .chart-header {
            background-color: #002040;
            border-bottom: 1px solid #005080;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            margin: 0;
            color: #e0e0e0;
        }
        
        .chart-body {
            padding: 20px;
            background-color: #004060;
        }
        
        .filter-section {
            background: #004060;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #005080;
        }
        
        .financial-section {
            display: none;
            margin-top: 30px;
        }
        
        .financial-section.active {
            display: block;
        }
        
        .period-info {
            background: linear-gradient(45deg, #004080, #005080);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #0070c0;
            color: #e0e0e0;
        }
        
        .data-table {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .chart-period-info {
            background: #004060;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #0070c0;
            color: #e0e0e0;
        }
        
        .card {
            background-color: #004060;
            border: 1px solid #005080;
            color: #e0e0e0;
        }
        
        .card-header {
            background-color: #002040;
            border-bottom: 1px solid #005080;
            color: #e0e0e0;
        }
        
        .form-control, .form-select {
            background-color: #005080;
            border: 1px solid #0070c0;
            color: #e0e0e0;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #006090;
            border-color: #0070c0;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(0, 112, 192, 0.25);
        }
        
        .btn-primary {
            background-color: #0070c0;
            border-color: #0070c0;
        }
        
        .btn-primary:hover {
            background-color: #0080d0;
            border-color: #0080d0;
        }
        
        .btn-outline-primary {
            color: #0070c0;
            border-color: #0070c0;
        }
        
        .btn-outline-primary:hover, .btn-outline-primary.active {
            background-color: #0070c0;
            border-color: #0070c0;
            color: white;
        }
        
        .table {
            color: #e0e0e0;
        }
        
        .table-dark {
            background-color: #002040;
        }
        
        .alert {
            background-color: #004060;
            border: 1px solid #005080;
            color: #e0e0e0;
        }
        
        .text-dark {
            color: #e0e0e0 !important;
        }
        
        .text-muted {
            color: #b0b0b0 !important;
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold mb-3">ì¬ë¬´ì œí‘œ ì‹œê°í™”</h1>
                <p class="lead">OpenDart APIë¥¼ í™œìš©í•œ ê¸°ì—… ì¬ë¬´ì •ë³´ ë¶„ì„ ë„êµ¬</p>
            </div>
            
            <div class="search-container">
                <div class="card shadow-lg">
                    <div class="card-body p-4">
                        <h5 class="card-title text-dark mb-3">
                            <i class="fas fa-search me-2"></i>ê¸°ì—… ê²€ìƒ‰
                        </h5>
                        <div class="input-group">
                            <input type="text" 
                                   id="companySearch" 
                                   class="form-control form-control-lg" 
                                   placeholder="íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤)"
                                   autocomplete="off">
                            <button class="btn btn-primary btn-lg" type="button" onclick="searchCompany()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="loading mt-3 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">ê²€ìƒ‰ ì¤‘...</span>
                            </div>
                        </div>
                        <div id="searchResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¬ë¬´ì œí‘œ ë¶„ì„ ì„¹ì…˜ -->
    <div id="financialSection" class="financial-section container-fluid">
        <div class="container">
            <!-- íšŒì‚¬ ì •ë³´ í—¤ë” -->
            <div id="companyHeader" class="row mb-4">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- í•„í„° ì„¹ì…˜ -->
            <div class="filter-section" id="filterSection">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ê¸°ê°„ ì •ë³´ -->
            <div id="periodInfo" class="period-info" style="display:none;">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ë¶„ì„ ìš”ì•½ -->
            <div id="analysisSummary">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div id="chartsSection">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ë°ì´í„° í…Œì´ë¸” -->
            <div id="dataTableSection">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ë¡œë”© í‘œì‹œ -->
            <div id="financialLoading" class="text-center" style="display:none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                </div>
                <p class="mt-3 h5">ì¬ë¬´ì œí‘œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let searchTimeout;
        let currentCorpCode = '';
        let currentCorpName = '';
        let currentViewMode = 'single';
        
        // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('companySearch').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    searchCompany();
                }, 300);
            } else {
                document.getElementById('searchResults').innerHTML = '';
            }
        });
        
        // ì—”í„° í‚¤ ì´ë²¤íŠ¸
        document.getElementById('companySearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCompany();
            }
        });
        
        function searchCompany() {
            const query = document.getElementById('companySearch').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            const loading = document.querySelector('.loading');
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">ìµœì†Œ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            loading.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    displaySearchResults(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    resultsDiv.innerHTML = '<div class="alert alert-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }
        
        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            results.forEach(company => {
                html += `
                    <div class="list-group-item company-result" onclick="selectCompany('${company.corp_code}', '${company.corp_name}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${company.corp_name}</h6>
                                <small class="text-muted">
                                    ì½”ë“œ: ${company.corp_code}
                                    ${company.stock_code ? ` | ì¢…ëª©ì½”ë“œ: ${company.stock_code}` : ''}
                                </small>
                            </div>
                            <div>
                                <i class="fas fa-arrow-right text-primary"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function selectCompany(corpCode, corpName) {
            currentCorpCode = corpCode;
            currentCorpName = corpName;
            
            // URL ì—…ë°ì´íŠ¸
            const url = new URL(window.location);
            url.searchParams.set('corp_code', corpCode);
            url.searchParams.set('corp_name', corpName);
            window.history.pushState({}, '', url);
            
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('searchResults').innerHTML = '';
            
            // ì¬ë¬´ì œí‘œ ì„¹ì…˜ í‘œì‹œ ë° í•„í„° ìƒì„±
            showFinancialSection();
            createFilters();
            
            // ê¸°ë³¸ ë°ì´í„° ë¡œë“œ (ë‹¨ì¼ ì—°ë„, 2022ë…„)
            loadFinancialData(corpCode, corpName, 'single', '2022', '', '', '11011');
        }
        
        function showFinancialSection() {
            document.getElementById('financialSection').classList.add('active');
            
            // íšŒì‚¬ í—¤ë” ìƒì„±
                         document.getElementById('companyHeader').innerHTML = `
                 <div class="col-12">
                     <div class="card border-primary">
                         <div class="card-body">
                             <h1 class="mb-0 text-white fw-bold">
                                 <i class="fas fa-building me-2"></i>${currentCorpName}
                                 <span class="badge bg-secondary fs-6 ms-2">${currentCorpCode}</span>
                             </h1>
                         </div>
                     </div>
                 </div>
             `;
        }
        
        function createFilters() {
            document.getElementById('filterSection').innerHTML = `
                <div class="row align-items-center mb-3">
                    <div class="col-md-4">
                        <label class="form-label">ì¡°íšŒ ë°©ì‹:</label>
                        <select class="form-select" id="viewMode" onchange="toggleViewMode()">
                            <option value="single">ë‹¨ì¼ ì—°ë„</option>
                            <option value="period">ê¸°ê°„ë³„ ë¶„ì„</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ë³´ê³ ì„œ ìœ í˜•:</label>
                        <select class="form-select" id="reportType">
                            <option value="11011">ì‚¬ì—…ë³´ê³ ì„œ</option>
                            <option value="11012">ë°˜ê¸°ë³´ê³ ì„œ</option>
                            <option value="11013">1ë¶„ê¸°ë³´ê³ ì„œ</option>
                            <option value="11014">3ë¶„ê¸°ë³´ê³ ì„œ</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search"></i> ì¡°íšŒ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ë‹¨ì¼ ì—°ë„ ì¡°íšŒ -->
                <div id="singleYearSection">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <label class="form-label">ì—°ë„ ì„ íƒ:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="selectYear('2020')">2020</button>
                                <button type="button" class="btn btn-outline-primary" onclick="selectYear('2021')">2021</button>
                                <button type="button" class="btn btn-primary" onclick="selectYear('2022')">2022</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ê¸°ê°„ë³„ ì¡°íšŒ -->
                <div id="periodSection" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">ì‹œì‘ ì—°ë„:</label>
                            <select class="form-select" id="startYear">
                                <option value="2015">2015</option>
                                <option value="2016">2016</option>
                                <option value="2017">2017</option>
                                <option value="2018">2018</option>
                                <option value="2019">2019</option>
                                <option value="2020" selected>2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ì¢…ë£Œ ì—°ë„:</label>
                            <select class="form-select" id="endYear">
                                <option value="2015">2015</option>
                                <option value="2016">2016</option>
                                <option value="2017">2017</option>
                                <option value="2018">2018</option>
                                <option value="2019">2019</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022" selected>2022</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-success" onclick="applyPeriod()">
                                    <i class="fas fa-chart-line"></i> ê¸°ê°„ ë¶„ì„ ì‹œì‘
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // í•„í„° ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleViewMode() {
            const viewMode = document.getElementById('viewMode').value;
            currentViewMode = viewMode;
            const singleSection = document.getElementById('singleYearSection');
            const periodSection = document.getElementById('periodSection');
            
            if (viewMode === 'period') {
                singleSection.style.display = 'none';
                periodSection.style.display = 'block';
            } else {
                singleSection.style.display = 'block';
                periodSection.style.display = 'none';
            }
        }
        
        function selectYear(year) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('#singleYearSection .btn').forEach(btn => {
                btn.className = 'btn btn-outline-primary';
            });
            event.target.className = 'btn btn-primary';
            
            // ë°ì´í„° ë¡œë“œ
            const reportCode = document.getElementById('reportType').value;
            loadFinancialData(currentCorpCode, currentCorpName, 'single', year, '', '', reportCode);
        }
        
        function applyFilters() {
            const reportCode = document.getElementById('reportType').value;
            if (currentViewMode === 'period') {
                applyPeriod();
            } else {
                const selectedYear = document.querySelector('#singleYearSection .btn-primary')?.textContent || '2022';
                loadFinancialData(currentCorpCode, currentCorpName, 'single', selectedYear, '', '', reportCode);
            }
        }
        
        function applyPeriod() {
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;
            const reportCode = document.getElementById('reportType').value;
            
            if (parseInt(startYear) > parseInt(endYear)) {
                alert('ì‹œì‘ ì—°ë„ëŠ” ì¢…ë£Œ ì—°ë„ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            loadFinancialData(currentCorpCode, currentCorpName, 'period', '', startYear, endYear, reportCode);
        }
        
        // ì¬ë¬´ì œí‘œ ë°ì´í„° ë¡œë”© (JSON API ì‚¬ìš©)
        function loadFinancialData(corpCode, corpName, viewMode, year, startYear, endYear, reportCode) {
            const loadingDiv = document.getElementById('financialLoading');
            const chartsSection = document.getElementById('chartsSection');
            const dataTableSection = document.getElementById('dataTableSection');
            const analysisSummary = document.getElementById('analysisSummary');
            const periodInfo = document.getElementById('periodInfo');
            
            // ë¡œë”© í‘œì‹œ
            loadingDiv.style.display = 'block';
            chartsSection.innerHTML = '';
            dataTableSection.innerHTML = '';
            analysisSummary.innerHTML = '';
            periodInfo.style.display = 'none';
            
            // JSON API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
            let url = '/financial-api?';
            const params = new URLSearchParams({
                corp_code: corpCode,
                corp_name: corpName,
                view_mode: viewMode,
                report_code: reportCode
            });
            
            if (viewMode === 'period') {
                params.append('start_year', startYear);
                params.append('end_year', endYear);
            } else {
                params.append('year', year);
            }
            
            url += params.toString();
            
            // JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            console.log('ğŸ” API í˜¸ì¶œ:', url);
            fetch(url)
                .then(response => {
                    console.log('ğŸ“Š ì‘ë‹µ ìƒíƒœ:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“‹ ì‘ë‹µ ë°ì´í„°:', data);
                    loadingDiv.style.display = 'none';
                    if (data.success) {
                        console.log('âœ… ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
                        displayFinancialData(data, viewMode, year, startYear, endYear);
                    } else {
                        console.error('âŒ API ì˜¤ë¥˜:', data.error);
                        showError(data.error || 'ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    console.error('âŒ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                    showError('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        function displayFinancialData(data, viewMode, year, startYear, endYear) {
            const chartsSection = document.getElementById('chartsSection');
            const dataTableSection = document.getElementById('dataTableSection');
            const analysisSummary = document.getElementById('analysisSummary');
            const periodInfo = document.getElementById('periodInfo');
            
            // ê¸°ê°„ ì •ë³´ í‘œì‹œ
            if (viewMode === 'period') {
                periodInfo.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">
                                <i class="fas fa-calendar-alt me-2"></i>ë¶„ì„ ê¸°ê°„: ${startYear}ë…„ ~ ${endYear}ë…„
                            </h5>
                            <p class="mb-0 text-muted">ê¸°ê°„ë³„ ì¬ë¬´ ì„±ê³¼ ë° íŠ¸ë Œë“œ ë¶„ì„</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-info fs-6">ê¸°ê°„ë³„ ë¶„ì„</span>
                        </div>
                    </div>
                `;
            } else {
                periodInfo.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">
                                <i class="fas fa-calendar me-2"></i>ë¶„ì„ ì—°ë„: ${year}ë…„
                            </h5>
                            <p class="mb-0 text-muted">ë‹¹ê¸°ì™€ ì „ê¸° ì¬ë¬´ìƒíƒœ ë¹„êµ ë¶„ì„</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-secondary fs-6">ë‹¨ì¼ ì—°ë„</span>
                        </div>
                    </div>
                `;
            }
            periodInfo.style.display = 'block';
            
            // ë¶„ì„ ìš”ì•½ í‘œì‹œ
            if (data.analysis_summary) {
                displayAnalysisSummary(data.analysis_summary);
            }
            
            // ì°¨íŠ¸ í‘œì‹œ - JSONì—ì„œ ë°›ì€ HTML ë¬¸ìì—´ì„ ì§ì ‘ ì‚½ì…
            if (data.charts) {
                displayCharts(data.charts, viewMode, data.financial_data);
            }
            
            // ë°ì´í„° í…Œì´ë¸” í‘œì‹œ
            if (data.financial_data) {
                displayDataTable(data.financial_data);
            }
        }

        function displayAnalysisSummary(summary) {
            const analysisSummary = document.getElementById('analysisSummary');
            if (!summary || !summary.key_metrics) return;
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-dark shadow">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0"><i class="fas fa-analytics me-2"></i>ê¸°ê°„ë³„ ë¶„ì„ ìš”ì•½</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6 class="text-muted">ë¶„ì„ ê¸°ê°„</h6>
                                            <h4 class="text-primary">${summary.period}</h4>
                                            <p class="small text-muted">
                                                ë¶„ì„ ì—°ë„: ${summary.years_analyzed ? summary.years_analyzed.join(', ') + 'ë…„' : ''}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="row">
            `;
            
            for (const [account, metrics] of Object.entries(summary.key_metrics)) {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <h6 class="text-dark mb-2">
                                <i class="fas fa-chart-bar me-1"></i>${account}
                            </h6>
                            <div class="small">
                                <div class="d-flex justify-content-between">
                                    <span>ì‹œì‘ê°’:</span>
                                    <strong>${metrics.start_value_formatted}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>ì¢…ë£Œê°’:</span>
                                    <strong>${metrics.end_value_formatted}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>ì´ ì„±ì¥ë¥ :</span>
                                    <strong class="${metrics.total_growth >= 0 ? 'text-success' : 'text-danger'}">
                                        ${metrics.total_growth.toFixed(1)}%
                                    </strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>ì—°í‰ê·  ì„±ì¥ë¥ :</span>
                                    <strong class="${metrics.cagr >= 0 ? 'text-success' : 'text-danger'}">
                                        ${metrics.cagr.toFixed(1)}%
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            analysisSummary.innerHTML = html;
        }
        
        function displayCharts(charts, viewMode, financialData) {
            console.log('ğŸ“Š ì°¨íŠ¸ í‘œì‹œ ì‹œì‘:', charts);
            const chartsSection = document.getElementById('chartsSection');
            let html = '';
            
                         // ë‹¹ê¸°/ì „ê¸° ì •ë³´ ì¶”ì¶œ
             let periodInfo = '';
             if (financialData && financialData.length > 0) {
                 const firstItem = financialData[0];
                 if (viewMode === 'single') {
                     periodInfo = `
                         <div class="chart-period-info">
                             <div class="row text-center">
                                 <div class="col-md-6">
                                     <strong>ë‹¹ê¸° (í˜„ì¬):</strong> ${firstItem.thstrm_nm || 'í˜„ì¬ ê¸°ê°„'} 
                                     <br><span class="text-muted">${firstItem.thstrm_dt || ''}</span>
                                 </div>
                                 <div class="col-md-6">
                                     <strong>ì „ê¸° (ì´ì „):</strong> ${firstItem.frmtrm_nm || 'ì´ì „ ê¸°ê°„'} 
                                     <br><span class="text-muted">${firstItem.frmtrm_dt || ''}</span>
                                 </div>
                             </div>
                         </div>
                     `;
                 }
             }
            
            console.log('ğŸ“ˆ ì°¨íŠ¸ ê°œìˆ˜:', Object.keys(charts).length);
            
                         // 1. ì¬ë¬´ì œí‘œ ì„¹ì…˜
             html += `<div class="mb-4"><h2 class="text-white fw-bold border-bottom pb-2" style="font-size: 2.2rem;">ğŸ“Š ì¬ë¬´ì œí‘œ</h2></div>`;
             
             // ì¬ë¬´ìƒíƒœí‘œ (ì™¼ìª½ ê·¸ë˜í”„, ì˜¤ë¥¸ìª½ ìš”ì•½í‘œ)
             if (charts.balance_sheet) {
                 console.log('ğŸ“Š ì¬ë¬´ìƒíƒœí‘œ ì°¨íŠ¸ ì¶”ê°€');
                 html += `
                     <div class="mb-4">
                         <div class="row">
                             <div class="col-lg-8 col-md-12 mb-3">
                                 <div class="chart-container">
                                                             <div class="chart-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ì¬ë¬´ìƒíƒœí‘œ</h5>
                        </div>
                                     <div class="chart-body">
                                         ${periodInfo}
                                         ${charts.balance_sheet}
                                     </div>
                                 </div>
                             </div>
                             ${charts.balance_sheet_table ? `
                             <div class="col-lg-4 col-md-12 mb-3">
                                 <div class="chart-container">
                                     <div class="chart-header">
                                         <h5 class="mb-0"><i class="fas fa-table me-2"></i>ìš”ì•½í‘œ</h5>
                                     </div>
                                     <div class="chart-body">
                                         ${charts.balance_sheet_table}
                                     </div>
                                 </div>
                             </div>
                             ` : ''}
                         </div>
                     </div>
                 `;
                 periodInfo = ''; // ì²« ë²ˆì§¸ ì°¨íŠ¸ì—ë§Œ í‘œì‹œ
             }
             
             // ì†ìµê³„ì‚°ì„œ (ì™¼ìª½ ê·¸ë˜í”„, ì˜¤ë¥¸ìª½ ìš”ì•½í‘œ)
             if (charts.income_statement) {
                 console.log('ğŸ“Š ì†ìµê³„ì‚°ì„œ ì°¨íŠ¸ ì¶”ê°€');
                 html += `
                     <div class="mb-4">
                         <div class="row">
                             <div class="col-lg-8 col-md-12 mb-3">
                                 <div class="chart-container">
                                                             <div class="chart-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ì†ìµê³„ì‚°ì„œ</h5>
                        </div>
                                     <div class="chart-body">
                                         ${charts.income_statement}
                                     </div>
                                 </div>
                             </div>
                             ${charts.income_statement_table ? `
                             <div class="col-lg-4 col-md-12 mb-3">
                                 <div class="chart-container">
                                     <div class="chart-header">
                                         <h5 class="mb-0"><i class="fas fa-table me-2"></i>ìš”ì•½í‘œ</h5>
                                     </div>
                                     <div class="chart-body">
                                         ${charts.income_statement_table}
                                     </div>
                                 </div>
                             </div>
                             ` : ''}
                         </div>
                     </div>
                 `;
             }
             
             // ì£¼ìš” ì¬ë¬´ë¹„ìœ¨ ì„¹ì…˜
             html += `<div class="mb-4"><h2 class="text-white fw-bold border-bottom pb-2" style="font-size: 2.2rem;">ğŸ“ˆ ì£¼ìš” ì¬ë¬´ë¹„ìœ¨</h2></div>`;
             
             // ìˆ˜ìµì„± ë¶„ì„ê³¼ ë¶€ì±„ë¹„ìœ¨ ë¶„ì„ì„ í•œ ì¤„ì— ë°°ì¹˜
             if (charts.profitability_radar || charts.debt_ratio_donut) {
                 html += `<div class="row mb-4">`;
                 
                 // ìˆ˜ìµì„± ë¶„ì„ (ë°©ì‚¬í˜•ì°¨íŠ¸)
                 if (charts.profitability_radar) {
                     console.log('ğŸ“Š ìˆ˜ìµì„± ë¶„ì„ ì°¨íŠ¸ ì¶”ê°€');
                     html += `
                         <div class="col-lg-6 col-md-12 mb-3">
                             <div class="chart-container">
                                                         <div class="chart-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>ìˆ˜ìµì„± ë¶„ì„</h5>
                        </div>
                                 <div class="chart-body">
                                     ${charts.profitability_radar}
                                 </div>
                             </div>
                         </div>
                     `;
                 }
                 
                 // ë¶€ì±„ë¹„ìœ¨ ë¶„ì„ (ë„ë„›ì°¨íŠ¸)
                 if (charts.debt_ratio_donut) {
                     console.log('ğŸ“Š ë¶€ì±„ë¹„ìœ¨ ë¶„ì„ ì°¨íŠ¸ ì¶”ê°€');
                     html += `
                         <div class="col-lg-6 col-md-12 mb-3">
                             <div class="chart-container">
                                                         <div class="chart-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>ë¶€ì±„ë¹„ìœ¨ ë¶„ì„</h5>
                        </div>
                                 <div class="chart-body">
                                     ${charts.debt_ratio_donut}
                                 </div>
                             </div>
                         </div>
                     `;
                 }
                 
                 html += `</div>`;
             }
            
                         // ë‚˜ë¨¸ì§€ ìš”ì†Œë“¤ì„ í•˜ìœ„ì— ë°°ì¹˜
             const remainingCharts = {};
             for (const [chartName, chartHtml] of Object.entries(charts)) {
                 if (!['balance_sheet', 'balance_sheet_table', 'income_statement', 'income_statement_table', 
                       'profitability_radar', 'debt_ratio_donut'].includes(chartName)) {
                     remainingCharts[chartName] = chartHtml;
                 }
             }
             
             if (Object.keys(remainingCharts).length > 0) {
                 html += `<div class="mt-4"><h3 class="text-muted border-bottom pb-2">ğŸ“Š ì¶”ê°€ ë¶„ì„ ì°¨íŠ¸</h3></div>`;
                
                for (const [chartName, chartHtml] of Object.entries(remainingCharts)) {
                    console.log(`ğŸ“Š ì¶”ê°€ ì°¨íŠ¸ ë°°ì¹˜: ${chartName}, HTML ê¸¸ì´: ${chartHtml.length}`);
                    html += `
                        <div class="chart-container">
                            ${chartHtml}
                        </div>
                    `;
                }
            }
            
            console.log('ğŸ“‹ ìµœì¢… HTML ê¸¸ì´:', html.length);
            chartsSection.innerHTML = html;
            console.log('âœ… ì°¨íŠ¸ HTML ì‚½ì… ì™„ë£Œ');
            
            // Plotly ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§ - ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì‹¤í–‰
            setTimeout(() => {
                console.log('ğŸ”„ Plotly ë Œë”ë§ ì‹œì‘');
                
                // Plotly ë¡œë“œ ëŒ€ê¸° í›„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                function waitForPlotlyAndExecuteScripts() {
                    if (typeof Plotly !== 'undefined') {
                        console.log('âœ… Plotly ë¡œë“œ ì™„ë£Œ, ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘');
                        
                        // ì‚½ì…ëœ HTML ë‚´ì˜ script íƒœê·¸ë“¤ì„ ì°¾ì•„ì„œ ì‹¤í–‰
                        const scripts = chartsSection.querySelectorAll('script');
                        console.log(`ğŸ“œ ë°œê²¬ëœ ìŠ¤í¬ë¦½íŠ¸ ê°œìˆ˜: ${scripts.length}`);
                        
                        scripts.forEach((script, index) => {
                            console.log(`ğŸ”„ ìŠ¤í¬ë¦½íŠ¸ ${index + 1} ì‹¤í–‰ ì¤‘...`);
                            try {
                                // evalì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰
                                eval(script.textContent);
                                console.log(`âœ… ìŠ¤í¬ë¦½íŠ¸ ${index + 1} ì‹¤í–‰ ì™„ë£Œ`);
                            } catch (error) {
                                console.error(`âŒ ìŠ¤í¬ë¦½íŠ¸ ${index + 1} ì‹¤í–‰ ì˜¤ë¥˜:`, error);
                            }
                        });
                        
                        // Plotly autoResize
                        console.log('âœ… Plotly autoResize í˜¸ì¶œ');
                        Plotly.autoResize();
                    } else {
                        console.log('â³ Plotly ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                        setTimeout(waitForPlotlyAndExecuteScripts, 100);
                    }
                }
                
                // Plotly ë¡œë“œ ëŒ€ê¸° ì‹œì‘
                waitForPlotlyAndExecuteScripts();
            }, 200);
        }
        
        function displayDataTable(data) {
            const dataTableSection = document.getElementById('dataTableSection');
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>ìƒì„¸ ì¬ë¬´ ë°ì´í„°</h5>
                    </div>
                    <div class="card-body">
                        <div class="data-table">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ê³„ì •ëª…</th>
                                        <th>êµ¬ë¶„</th>
                                        <th>ë‹¹ê¸°</th>
                                        <th>ì „ê¸°</th>
                                        <th>ë‹¨ìœ„</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            data.slice(0, 30).forEach(item => {
                html += `
                    <tr>
                        <td><strong>${item.account_nm}</strong></td>
                        <td>
                            ${item.sj_div === 'BS' ? 
                                '<span class="badge bg-primary">ì¬ë¬´ìƒíƒœí‘œ</span>' : 
                                '<span class="badge bg-success">ì†ìµê³„ì‚°ì„œ</span>'
                            }
                        </td>
                        <td>${item.thstrm_amount_formatted || item.thstrm_amount || '-'}</td>
                        <td>${item.frmtrm_amount_formatted || item.frmtrm_amount || '-'}</td>
                        <td><small class="text-muted">${item.currency || 'ì›'}</small></td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            dataTableSection.innerHTML = html;
        }
        
        function showError(message) {
            const chartsSection = document.getElementById('chartsSection');
            chartsSection.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
        
        // Plotly ë¡œë“œ ìƒíƒœ í™•ì¸
        function checkPlotlyLoaded() {
            if (typeof Plotly !== 'undefined') {
                console.log('âœ… Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                return true;
            } else {
                console.log('â³ Plotly ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                return false;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸
        window.addEventListener('load', function() {
            // Plotly ë¡œë“œ í™•ì¸
            if (!checkPlotlyLoaded()) {
                console.log('âš ï¸ Plotlyê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì°¨íŠ¸ ë Œë”ë§ì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const corpCode = urlParams.get('corp_code');
            const corpName = urlParams.get('corp_name');
            
            if (corpCode && corpName) {
                document.getElementById('companySearch').value = corpName;
                selectCompany(corpCode, corpName);
            }
        });
    </script>
</body>
</html>